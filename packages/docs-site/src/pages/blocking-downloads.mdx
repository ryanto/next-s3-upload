# Blocking downloads

With next-s3-upload every upload generates a unique URL on S3. For example, if a user uploads `photo.jpg`, the uploaded file will live at `https://bucket.s3.amazonaws.com/next-s3-uploads/61e80089-ede1-442f-a6f6-5854d66fd4f6/photo.jpg`.

At first glance these URLs might look completely random and secure, but at the end of the day they are public URLs and [anyone could access them](https://security.stackexchange.com/questions/53458/is-it-safe-to-rely-on-uuids-for-privacy).

When uploading profile photos and videos files this URL scheme works well, since ultimately these uploads are meant to be public and sharable on the web.

However, you might have some uploads like bank account statements that you do not want to be accessible by a URL.

This guide will show you how to have two types of uploads, one for public files and one for private files.

## Private S3 folder

First, let's change the S3 bucket policy to block downloads for private files.

In your S3 bucket go to permissions tab and edit the bucket policy and paste in this JSON.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Statement1",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::BUCKET_NAME/next-s3-uploads/_private/*"
    },
    {
      "Sid": "Statement2",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::BUCKET_NAME/next-s3-uploads/_public/*"
    }
  ]
}
```

ðŸš¨ **Important** ðŸš¨ Before saving the policy, you'll need to replace:

|                 |                          |
| --------------- | ------------------------ |
| **BUCKET_NAME** | The name of your bucket. |
|                 |                          |

This policy creates two rules for your S3 bucket:

1. Downloads are blocked for files in the `_private` directory.
1. Downloads are allowed for files in the `_public` directory.

## API Route

Next, configure the next-s3-upload API Route to put private uploads in the bucket's private directory.

```js
// pages/api/s3-upload.js

import { APIRoute, uuid } from "next-s3-upload";

export default APIRoute.configure({
  async key(req, filename) {
    let isPrivate = req.body.isPrivate;
    let key = `next-s3-uploads/${
      isPrivate ? "_private" : "_public"
    }/${uuid()}/${filename}`;

    return key;
  }
});
```

The above configuration will allow users to specify if their upload is private. Private uploads will end up in the `_private` folder on S3. Uploads that are not marked as private will end up in the `_public` folder.

## Uploading private files

In the frontend, when a user is uploading a file they can pass along the `isPrivate` flag to put the upload in the private directory.

```jsx
// react code
function MyComponent {
  let { uploadToS3 } = useS3Upload();

  const handleFileChange = async ({ target }) => {
    let file = target.files[0];

    let { key } = await uploadToS3(file, {
      endpoint: {
        request: {
          body: {
            isPrivate: true
          }
        }
      }
    });

    console.log('uploaded private file', key)
  };

  // ...

  <input
    type="file"
    name="file"
    data-test="file-input"
    onChange={handleFileChange}
  />
}

```

Any file uploaded by the above component will end up in the private folder and no one will be able to download it.

## Accessing private uploads

Since these files are not publicly accessible, the URL returned by `uploadToS3` is pretty much useless. You'll see an access denied error as soon as you try to access it.

S3 has the ability to generate temporary URLs to access these private files.

To help you with this, next-s3-upload comes with a helper called `generateTemporaryUrl` that will take an S3 key and generate a signed URL that allows users to access specific private files.

```js
// pages/api/generate-temporary-url

```

In this example, the frontend can ask an API route to generate an access URL for a key.

```js
// Upload private file

// Ask API route for key

// log the temporary URL
```

Note: Generating these URLs requires access to your private AWS keys, so it can only be done in a secure context like an API route. The React frontend code cannot generate these URLs.

These URLs are temporary and only accessible for one hour.

## Other ways to access

If you do not want to generate temporary URLs you access private files, you can always download the files from your S3 bucket using the AWS admin console.
